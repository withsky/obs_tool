# OBS下载工具 - 使用手册

> **专为非技术人员设计的图形化下载工具**  
> 通过Linux服务器中转，安全下载华为OBS存储桶中的文件

---

## 📋 目录

1. [什么是OBS下载工具？](#什么是obs下载工具)
2. [系统要求](#系统要求)
3. [快速开始（Windows用户）](#快速开始windows用户)
4. [详细使用说明](#详细使用说明)
5. [Linux服务器部署（管理员）](#linux服务器部署管理员)
6. [常见问题](#常见问题)
7. [故障排除](#故障排除)

---

## 什么是OBS下载工具？

### 通俗解释

想象OBS（对象存储服务）是一个**巨大的网络硬盘**，里面存着公司的大量数据文件。但是，由于网络安全限制，你的Windows电脑**不能直接访问**这个硬盘。

**OBS下载工具**就像是：
- 📞 **电话中转**：Windows电脑打电话给Linux服务器
- 🤖 **跑腿小弟**：Linux服务器帮你从OBS下载文件
- 📊 **进度看板**：Windows电脑实时看到下载进度

### 工作流程图

```
┌─────────────────┐     SSH连接      ┌─────────────────┐     网络      ┌───────────┐
│   Windows电脑   │ ═══════════════► │  Linux服务器    │ ═══════════► │  OBS存储  │
│  （你的电脑）    │                  │ （10.155.106.228）│              │           │
│                 │ ◄═══════════════ │                 │ ◄═══════════ │           │
└─────────────────┘   显示进度        └─────────────────┘   下载文件    └───────────┘
```

### 核心功能

| 功能 | 说明 | 适用场景 |
|------|------|----------|
| 📁 **单文件下载** | 下载单个文件 | 下载某个具体文件 |
| 📂 **文件夹同步** | 批量下载整个文件夹 | 下载项目数据、备份文件 |
| ⏰ **时间过滤** | 只下载某个日期后的文件 | 避免下载过时的旧文件 |
| 🔄 **断点续传** | 中断后从断点继续下载 | 大文件下载，网络不稳定 |
| 📊 **实时进度** | 显示下载速度和进度 | 随时掌握下载状态 |
| 👥 **多用户共享** | 多人看到同一任务列表 | 团队协作 |

---

## 系统要求

### Windows客户端要求

- **操作系统**：Windows 10 或 Windows 11
- **网络**：能够访问 `10.155.106.228` 的SSH端口（22）
- **权限**：普通用户权限即可

### Linux服务器要求

- **操作系统**：CentOS 7/8 或 Ubuntu 18.04/20.04/22.04
- **Python**：3.8 或更高版本
- **网络**：能够访问华为OBS服务
- **存储空间**：充足（根据下载文件大小）

---

## 快速开始（Windows用户）

### 第一步：获取软件

1. 从管理员处获取安装包：`OBS下载工具.zip`
2. 解压到任意位置，例如：`D:\OBS下载工具\`

```
OBS下载工具/
├── OBS下载工具.exe    ← 双击运行这个
└── config/
    └── settings.json  ← 配置文件
```

### 第二步：首次运行

1. **双击** `OBS下载工具.exe`
2. 等待连接服务器（约3-5秒）
3. 看到主界面即表示连接成功

### 第三步：开始下载

#### 方式一：浏览文件后下载（推荐）

1. 点击主界面右上角的 **"🌐 浏览文件"** 按钮
2. 在文件浏览器中查看OBS文件列表
3. 选择要下载的文件
4. 点击 **"📥 下载选中"**
5. 在主界面查看下载进度

#### 方式二：直接输入路径下载

1. 点击主界面右上角的 **"📥 新建下载"** 按钮
2. 输入OBS文件路径（如：`data/backup/file.zip`）
3. 选择保存位置（默认：`/railway-efs/000-tfds/`）
4. 点击 **"✓ 开始下载"**

---

## 详细使用说明

### 1. 主界面介绍

```
┌─────────────────────────────────────────────────────────────────┐
│  ☁️ OBS下载工具                                          🌐 📥 │  ← 顶部工具栏
├──────────────────┬──────────────────────────────────────────────┤
│  📊 统计概览      │  📋 下载任务                                  │
│                  │                                               │
│  ▶️ 运行中: 2     │  ┌─────────────────────────────────────────┐ │
│  ⏳ 待处理: 3     │  │ 文件名        状态   进度    大小    操作│ │  ← 任务列表
│  ✅ 已完成: 10    │  ├─────────────────────────────────────────┤ │
│  ⚡ 速度: 5 MB/s  │  │ data.zip     ▶️下载中 45%   1.2GB  ⏸ ✕ │ │
│                  │  │ backup.tar   ⏳等待中  0%   500MB  ▶ ✕ │ │
│                  │  └─────────────────────────────────────────┘ │
├──────────────────┴──────────────────────────────────────────────┤
│  ✓ 已连接到 10.155.106.228  |  就绪                              │  ← 状态栏
└─────────────────────────────────────────────────────────────────┘
```

#### 界面元素说明

| 区域 | 说明 |
|------|------|
| **统计概览** | 显示当前运行中、待处理、已完成的任务数量，以及当前下载速度 |
| **任务列表** | 显示所有下载任务，包括文件名、状态、进度、大小，以及操作按钮 |
| **状态栏** | 显示连接状态和系统消息 |

### 2. 文件浏览器详解

点击 **"🌐 浏览文件"** 后打开的文件浏览器：

```
┌─────────────────────────────────────────────────────────────────┐
│ ☁️ OBS文件浏览器                                    🔄 刷新    │
├─────────────────────────────────────────────────────────────────┤
│ 全部文件                                                        │  ← 面包屑导航
├────────────────┬────────────────────────────────────────────────┤
│ 快速导航        │ 📁 文件夹名称                                    │
│                │    📄 file1.zip    100MB    2024-01-15 10:30   │
│ 📁 全部文件     │    📄 file2.zip    200MB    2024-01-16 14:20   │
│ ⏰ 最近更新     │                                                 │
│ 📦 大文件       │ 📁 project_data/                               │
│ ────────────   │    📄 data.csv     50MB     2024-01-17 09:00   │
│ 📌 收藏夹1      │                                                 │
│ 📌 收藏夹2      │                                                 │
├────────────────┴────────────────────────────────────────────────┤
│ 只显示晚于: [2024-01-01] 🔍 筛选                                 │  ← 时间过滤
├─────────────────────────────────────────────────────────────────┤
│ 已选择: data.zip                                               │  ← 选中信息
│ [📥 下载选中] [☁️ 同步文件夹] [✕ 关闭]                          │  ← 操作按钮
└─────────────────────────────────────────────────────────────────┘
```

#### 左侧导航栏

- **📁 全部文件**：显示OBS中的所有文件
- **⏰ 最近更新**：显示最近修改的20个文件
- **📦 大文件**：显示最大的20个文件
- **📌 收藏夹**：显示收藏的常用路径

#### 文件列表操作

| 操作 | 说明 |
|------|------|
| **单击文件** | 选中文件，底部显示文件详情 |
| **双击文件** | 直接下载该文件 |
| **单击文件夹** | 选中文件夹 |
| **双击文件夹** | 进入该文件夹 |

#### 时间过滤功能

在文件浏览器底部，可以设置 **"只显示晚于"** 某个日期的文件：

1. 在输入框中输入日期（格式：`2024-01-01`）
2. 点击 **"🔍 筛选"** 按钮
3. 文件列表只显示该日期后修改的文件

**使用场景**：
- 只下载本周更新的文件
- 避免下载几年前的旧数据
- 同步特定时间段的新文件

### 3. 文件夹同步详解

#### 什么是文件夹同步？

文件夹同步会**批量下载整个文件夹中的所有文件**，而不是一个个手动选择。

#### 操作步骤

1. 在文件浏览器中选中一个文件夹（单击文件夹名称）
2. 点击底部的 **"☁️ 同步文件夹"** 按钮
3. 选择是否应用时间过滤（可选）
4. 点击确认
5. 系统会为文件夹中的每个文件创建一个下载任务

#### 同步选项

| 选项 | 说明 |
|------|------|
| **同步整个文件夹** | 下载文件夹中的所有文件 |
| **只同步某个日期后的文件** | 避免下载旧文件，节省时间 |

**示例**：
- 同步 `project_data/` 文件夹
- 设置时间过滤为 `2024-01-01`
- 只下载该文件夹中2024年1月1日后修改的文件

### 4. 任务管理

#### 任务状态说明

| 状态 | 图标 | 说明 | 可操作 |
|------|------|------|--------|
| **等待中** | ⏳ | 任务已创建，等待开始 | 取消 |
| **下载中** | ▶️ | 正在下载文件 | 暂停、取消 |
| **已暂停** | ⏸️ | 下载被暂停 | 继续、取消 |
| **已完成** | ✅ | 下载成功 | 无 |
| **已失败** | ❌ | 下载失败 | 重试 |
| **已取消** | 🚫 | 任务被取消 | 重新开始 |

#### 任务操作按钮

在每个任务行的右侧，有三个操作按钮：

- **⏸ 暂停**：暂停正在下载的任务（可恢复）
- **▶ 继续**：恢复暂停的任务
- **✕ 取消**：取消任务（不可恢复）

### 5. 断点续传功能

#### 什么是断点续传？

想象你在下载一个**10GB的大文件**，下载到**5GB时网络断开**。传统的下载工具需要**重新开始下载**，而断点续传会**从5GB处继续下载**，节省时间和流量。

#### 使用方式

**无需任何操作，自动生效！**

- 下载中断后，任务状态变为 **"已暂停"**
- 点击 **"▶ 继续"** 按钮
- 自动从断点继续下载

#### 技术原理

1. 文件被分成**4MB的小块**（chunk）
2. 每下载完一块，标记为完成
3. 续传时检查哪些块已完成
4. 只下载未完成的块
5. 最后合并所有块

---

## Linux服务器部署（管理员）

### 环境要求

- Linux服务器（CentOS 7/8 或 Ubuntu 18.04/20.04/22.04）
- Python 3.8+
- 能够访问华为OBS服务
- 存储空间充足

### 部署步骤

#### 1. 上传代码

```bash
# 将代码上传到服务器
cd /data9
mkdir -p obs_tool
cd obs_tool
# 上传所有文件...
```

#### 2. 安装依赖

```bash
# 安装Python依赖
pip install obs-python-sdk paramiko

# 或者使用conda（推荐）
conda install -c conda-forge paramiko
pip install obs-python-sdk
```

#### 3. 配置OBS认证

编辑 `config.json`：

```json
{
  "bucketName": "tfds-ht",
  "localDir": "/railway-efs/000-tfds/",
  "pieceSize": 4194304,
  "maxRetries": 6,
  "backoffBaseSec": 2.0,
  "heartbeatIntervalSec": 30.0,
  "server": "https://obs.cn-north-4.myhuaweicloud.com",
  "accessKeyId": "你的AK",
  "secretAccessKey": "你的SK",
  "concurrency": 5
}
```

#### 4. 安装systemd服务

```bash
# 以root权限运行
sudo bash install_linux_service.sh
```

这个脚本会：
1. 创建必要的目录
2. 复制服务文件
3. 设置权限
4. 启动服务

#### 5. 验证安装

```bash
# 检查服务状态
systemctl status obs-daemon

# 查看日志
tail -f /data9/obs_tool/logs/daemon.log
```

### 服务管理命令

```bash
# 启动服务
sudo systemctl start obs-daemon

# 停止服务
sudo systemctl stop obs-daemon

# 重启服务
sudo systemctl restart obs-daemon

# 查看状态
sudo systemctl status obs-daemon

# 设置开机自启
sudo systemctl enable obs-daemon

# 禁用开机自启
sudo systemctl disable obs-daemon
```

### 目录结构说明

```
/data9/obs_tool/
├── config.json                 # 主配置文件
├── linux_server/               # Linux服务端代码
│   ├── daemon.py              # 守护进程主程序
│   ├── obs_operator.py        # OBS操作封装
│   ├── task_manager.py        # 任务管理
│   ├── chunk_downloader.py    # 分片下载器
│   ├── chunk_verifier.py      # 分片验证
│   ├── status_db.py           # 状态数据库
│   ├── folder_sync.py         # 文件夹同步
│   ├── cli.py                 # 命令行接口
│   ├── obs-daemon.service     # systemd服务文件
│   └── config.py              # 配置读取
├── storage/                    # 数据存储
│   ├── tasks_db.json          # 任务数据库
│   ├── history.json           # 下载历史
│   ├── favorites.json         # 收藏夹
│   └── progress/              # 进度文件
├── logs/                       # 日志目录
│   └── daemon.log             # 守护进程日志
└── install_linux_service.sh   # 安装脚本
```

### 并发控制配置

在 `config.json` 中设置：

```json
{
  "concurrency": 5  // 最大并发数，默认5个
}
```

**说明**：
- 如果服务器性能好，可以增加（如8或10）
- 如果网络不稳定，可以减少（如3）

---

## 常见问题

### Q1: Windows端提示"连接失败"怎么办？

**可能原因和解决方案**：

1. **网络不通**
   - 检查能否ping通服务器：`ping 10.155.106.228`
   - 检查防火墙设置

2. **SSH端口不通**
   - 检查SSH服务是否启动
   - 检查端口是否开放：`telnet 10.155.106.228 22`

3. **密码错误**
   - 联系管理员确认密码
   - 检查配置文件中的密码是否正确

### Q2: 下载速度很慢怎么办？

**可能原因**：

1. **网络带宽限制**
   - 检查服务器和OBS之间的网络带宽
   
2. **并发数设置**
   - 增加并发数（但不要超过服务器性能）

3. **文件本身较小**
   - 小文件下载速度显示不准确，属于正常现象

### Q3: 如何查看已下载的文件？

下载的文件保存在Linux服务器的 `/railway-efs/000-tfds/` 目录下。

**查看方式**：
```bash
# SSH登录服务器
ssh dl@10.155.106.228

# 查看下载目录
ls -la /railway-efs/000-tfds/

# 查看文件大小
du -sh /railway-efs/000-tfds/*
```

### Q4: 任务状态一直显示"等待中"怎么办？

**可能原因**：

1. **并发数已满**
   - 当前已有5个任务在运行
   - 等待其他任务完成

2. **守护进程未启动**
   - 在服务器上检查服务状态
   - 重启服务：`sudo systemctl restart obs-daemon`

### Q5: 如何暂停所有下载？

**方法**：
1. 在Windows端，逐个点击任务的暂停按钮
2. 或在服务器端停止服务：`sudo systemctl stop obs-daemon`

### Q6: 下载的文件不完整怎么办？

**解决方案**：
1. 使用断点续传功能：点击任务的 **"▶ 继续"** 按钮
2. 如果续传失败，删除任务后重新下载

### Q7: 多人同时使用会冲突吗？

**不会冲突！**

- 所有用户共享同一个任务列表
- 一个人创建的任务，其他人也能看到
- 并发控制确保最多5个任务同时运行
- 写锁保护保证数据一致性

---

## 故障排除

### 1. Windows端故障

#### 问题：程序打不开

**检查步骤**：
1. 确认使用的是Windows 10/11
2. 检查是否有杀毒软件拦截
3. 尝试以管理员身份运行

#### 问题：界面卡住

**解决方案**：
1. 等待30秒看是否恢复
2. 如果仍卡住，关闭后重新打开
3. 检查网络连接

### 2. Linux端故障

#### 问题：服务无法启动

**查看日志**：
```bash
# 查看服务日志
journalctl -u obs-daemon -f

# 查看应用日志
tail -f /data9/obs_tool/logs/daemon.log
```

**常见错误**：
- 端口被占用：检查是否有其他实例在运行
- 权限不足：检查目录权限
- 配置文件错误：检查JSON格式

#### 问题：任务数据库损坏

**修复方法**：
```bash
# 停止服务
sudo systemctl stop obs-daemon

# 备份数据库
cp /data9/obs_tool/storage/tasks_db.json /data9/obs_tool/storage/tasks_db.json.bak

# 如果损坏，可以从备份恢复
# 或清空数据库（会丢失所有任务）
echo '{}' > /data9/obs_tool/storage/tasks_db.json

# 启动服务
sudo systemctl start obs-daemon
```

### 3. 网络故障

#### 问题：无法连接OBS

**检查步骤**：
1. 检查服务器能否访问OBS：
   ```bash
   curl -I https://obs.cn-north-4.myhuaweicloud.com
   ```
2. 检查AK/SK是否正确
3. 检查OBS服务是否正常

---

## 技术细节（供管理员参考）

### 并发控制机制

```python
最大并发数 = 5

运行中的任务数 <= 5:
    - 新任务立即执行
    
运行中的任务数 >= 5:
    - 新任务进入等待队列
    - 有任务完成后，自动执行等待队列中的任务
```

### 写锁机制

使用Linux文件锁（fcntl）实现跨进程写保护：

```python
# 获取锁
fcntl.flock(lock_fd, fcntl.LOCK_EX)

# 执行写操作
write_to_database()

# 释放锁
fcntl.flock(lock_fd, fcntl.LOCK_UN)
```

**保证**：
- 同时只有一个进程能写数据库
- 防止数据损坏
- 多用户并发安全

### 数据一致性保障

1. **原子写操作**：先写临时文件，再重命名
2. **文件锁保护**：读写操作都加锁
3. **定期清理**：自动清理7天前的已完成任务
4. **日志记录**：所有操作都有日志，便于追溯

---

## 联系支持

如有问题，请联系：
- 系统管理员
- 或提交Issue到项目仓库

---

**最后更新**：2024年1月  
**版本**：v1.0
